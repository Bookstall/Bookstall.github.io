---
layout: post
author: bookstall
tags: LLM
categories: [LLM]
excerpt: FastChatï¼šåŸºäº FastAPI æ„å»ºå¤§æ¨¡å‹åŠ è½½æœåŠ¡
keywords: LLM
title: FastChatï¼šåŸºäº FastAPI æ„å»ºå¤§æ¨¡å‹åŠ è½½æœåŠ¡
mathjax: true
---



## FastChat ä»‹ç»

FastChat æ˜¯ä¸€ä¸ªå¼€æ”¾å¹³å°ï¼Œç”¨äºè®­ç»ƒã€æœåŠ¡å’Œè¯„ä¼°åŸºäºå¤§å‹è¯­è¨€æ¨¡å‹çš„èŠå¤©æœºå™¨äººã€‚

FastChat çš„æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ï¼š

- æœ€å…ˆè¿›æ¨¡å‹ï¼ˆä¾‹å¦‚ Vicunaã€MT-Benchï¼‰çš„è®­ç»ƒå’Œè¯„ä¼°ä»£ç 

- å…·æœ‰ Web UI ä»¥åŠä¸ OpenAI å…¼å®¹çš„ RESTful API çš„åˆ†å¸ƒå¼å¤šæ¨¡å‹æœåŠ¡ç³»ç»Ÿ


### æ¶æ„

![FastChat æ¶æ„å›¾](https://github.com/lm-sys/FastChat/raw/main/assets/server_arch.png)




## FastChat ä½¿ç”¨

### å®‰è£…

```shell
$ pip install fastchat
```

### åŸºæœ¬ä½¿ç”¨ï¼šCLI æ¨¡å¼

> **å• GPU çš„ä½¿ç”¨æ–¹æ³•**

```shell
$ CUDA_VISIBLE_DEVICES=4 python -m fastchat.serve.cli --model-path ./model/chatglm2-6b --debug
```

å…¶ä¸­ï¼Œ

- `--model-path` å¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶å¤¹ï¼Œä¹Ÿå¯ä»¥æ˜¯ Hugging Face å­˜å‚¨åº“åç§°

- `--debug` å¯ä»¥æ‰“å°æœ‰ç”¨çš„è°ƒè¯•ä¿¡æ¯ï¼ˆä¾‹å¦‚æç¤ºã€ç”Ÿæˆ token çš„é€Ÿåº¦ï¼‰

è¾“å‡ºçš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 7/7 [00:10<00:00,  1.45s/it]
ChatGLMForConditionalGeneration(
  (transformer): ChatGLMModel(
    (embedding): Embedding(
      (word_embeddings): Embedding(65024, 4096)
    )
    (rotary_pos_emb): RotaryEmbedding()
    (encoder): GLMTransformer(
      (layers): ModuleList(
        (0-27): 28 x GLMBlock(
          (input_layernorm): RMSNorm()
          (self_attention): SelfAttention(
            (query_key_value): Linear(in_features=4096, out_features=4608, bias=True)
            (core_attention): CoreAttention(
              (attention_dropout): Dropout(p=0.0, inplace=False)
            )
            (dense): Linear(in_features=4096, out_features=4096, bias=False)
          )
          (post_attention_layernorm): RMSNorm()
          (mlp): MLP(
            (dense_h_to_4h): Linear(in_features=4096, out_features=27392, bias=False)
            (dense_4h_to_h): Linear(in_features=13696, out_features=4096, bias=False)
          )
        )
      )
      (final_layernorm): RMSNorm()
    )
    (output_layer): Linear(in_features=4096, out_features=65024, bias=False)
  )
)
é—®: ä½ å¥½
ç­”: ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚

{'conv_template': 'chatglm2', 'prompt': '[Round 1]\n\né—®ï¼šä½ å¥½\n\nç­”ï¼š', 'outputs': 'ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚', 'speed (token/s)': 13.29}

é—®: è¯·ä½ è®²ä¸€ä¸ªå†·ç¬‘è¯
ç­”: ä¸‹é¢æ˜¯ä¸€ä¸ªå†·ç¬‘è¯ï¼š

æœ‰ä¸€å¤©ï¼Œè€å¸ˆåœ¨è¯¾å ‚ä¸Šé—®ï¼šâ€œå¦‚æœæœ‰äº”åªé¸Ÿç«™åœ¨æ ‘æä¸Šï¼Œä½ ç”¨æ°”æªæ‰“æ­»äº†ä¸€åªï¼Œè¿˜å‰©ä¸‹å‡ åªï¼Ÿâ€

å­¦ç”Ÿå›ç­”ï¼šâ€œè¿˜å‰©ä¸‹é›¶åªï¼Œå› ä¸ºå…¶ä»–é¸Ÿä¼šè¢«æªå£°å“é£ã€‚â€

è€å¸ˆæ²‰æ€äº†ä¸€ä¼šå„¿ï¼Œç„¶åæ‘‡äº†æ‘‡å¤´ï¼šâ€œè¿™æ ·å•Šï¼Œé‚£åªèƒ½å†ç­‰ç­‰äº†ï¼Œç­‰ç¬¬äº”åªé¸Ÿè‡ªå·±é£ä¸‹æ¥çš„æ—¶å€™å†æ‰“ã€‚â€

å­¦ç”Ÿå›åº”ï¼šâ€œå¤ªå¥½äº†ï¼Œæˆ‘æ­£å¥½æœ‰è¶³å¤Ÿçš„æ—¶é—´å¯ä»¥å†™ä¸€ç¯‡æ–‡ç« ã€‚â€

{'conv_template': 'chatglm2', 'prompt': '[Round 1]\n\né—®ï¼šä½ å¥½\n\nç­”ï¼šä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚\n\n[Round 2]\n\né—®ï¼šè¯·ä½ è®²ä¸€ä¸ªå†·ç¬‘è¯\n\nç­”ï¼š', 'outputs': 'ä¸‹é¢æ˜¯ä¸€ä¸ªå†·ç¬‘è¯ï¼š\n\næœ‰ä¸€å¤©ï¼Œè€å¸ˆåœ¨è¯¾å ‚ä¸Šé—®ï¼šâ€œå¦‚æœæœ‰äº”åªé¸Ÿç«™åœ¨æ ‘æä¸Šï¼Œä½ ç”¨æ°”æªæ‰“æ­»äº†ä¸€åªï¼Œè¿˜å‰©ä¸‹å‡ åªï¼Ÿâ€\n\nå­¦ç”Ÿå›ç­”ï¼šâ€œè¿˜å‰©ä¸‹é›¶åªï¼Œå› ä¸ºå…¶ä»–é¸Ÿä¼šè¢«æªå£°å“é£ã€‚â€\n\nè€å¸ˆæ²‰æ€äº†ä¸€ä¼šå„¿ï¼Œç„¶åæ‘‡äº†æ‘‡å¤´ï¼šâ€œè¿™æ ·å•Šï¼Œé‚£åªèƒ½å†ç­‰ç­‰äº†ï¼Œç­‰ç¬¬äº”åªé¸Ÿè‡ªå·±é£ä¸‹æ¥çš„æ—¶å€™å†æ‰“ã€‚â€\n\nå­¦ç”Ÿå›åº”ï¼šâ€œå¤ªå¥½äº†ï¼Œæˆ‘æ­£å¥½æœ‰è¶³å¤Ÿçš„æ—¶é—´å¯ä»¥å†™ä¸€ç¯‡æ–‡ç« ã€‚â€', 'speed (token/s)': 40.36}

é—®: è¯·ä½ è§£é‡Šä¸€ä¸‹é»‘æ´
ç­”: é»‘æ´æ˜¯å®‡å®™ä¸­ä¸€ç§æå…¶å·¨å¤§è´¨é‡å¯†é›†çš„å¤©ä½“ï¼Œå®ƒçš„å­˜åœ¨åŸºäºçˆ±å› æ–¯å¦çš„å¹¿ä¹‰ç›¸å¯¹è®ºã€‚é»‘æ´æ˜¯ç”±ä¸€ä¸ªäº‹ä»¶è§†ç•Œæ‰€åŒ…å›´çš„åŒºåŸŸï¼Œäº‹ä»¶è§†ç•Œæ˜¯ä¸€ç§ç±»ä¼¼äºæ•°å­¦â€œæ— å›å¤´ç‚¹â€çš„èŒƒå›´ï¼Œä¸€æ—¦ä»»ä½•ä¸œè¥¿è¿›å…¥äº†äº‹ä»¶è§†ç•Œï¼Œå°±å†ä¹Ÿæ— æ³•é€ƒè„±é»‘æ´çš„å¼•åŠ›ã€‚

é»‘æ´çš„å½¢æˆé€šå¸¸æ˜¯ç”±äºä¸€ä¸ªè¶…å¤§è´¨é‡æ’æ˜Ÿåœ¨æ­»äº¡æ—¶ï¼Œå…¶æ ¸å¿ƒå› ä¸ºå†…éƒ¨çš„å¼•åŠ›è€Œå¡Œç¼©æˆäº†ä¸€ä¸ªéå¸¸å°çš„åŒºåŸŸï¼Œå½¢æˆäº†ä¸€ä¸ªéå¸¸è‡´å¯†çš„ç‰©ä½“ã€‚è¿™ä¸ªç‰©ä½“çš„å¼•åŠ›éå¸¸å¼ºå¤§ï¼Œç”šè‡³è¿å…‰ä¹Ÿæ— æ³•é€ƒè„±ï¼Œå› æ­¤åœ¨å®‡å®™ä¸­çœ‹èµ·æ¥å°±åƒæ˜¯ä¸€ä¸ªâ€œé»‘æ´â€ã€‚

é»‘æ´çš„å¤§å°ç”±å…¶è´¨é‡å†³å®šï¼Œè´¨é‡è¶Šå¤§ï¼Œé»‘æ´çš„å¼•åŠ›å°±è¶Šå¼ºï¼Œäº‹ä»¶è§†ç•Œä¹Ÿå°±è¶Šå¤§ã€‚é»‘æ´çš„è´¨é‡å¯ä»¥é€šè¿‡æµ‹é‡å…¶è‡ªè½¬å’Œè†¨èƒ€æ¥ä¼°è®¡ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è§‚å¯Ÿå‘¨å›´å¤©ä½“çš„è¿åŠ¨æ¥ç¡®å®šã€‚

é»‘æ´æ˜¯å®‡å®™ä¸­æœ€ç¥ç§˜ã€æœ€å…·æœ‰æŒ‘æˆ˜æ€§çš„å¤©ä½“ä¹‹ä¸€ï¼Œå¯¹äºæˆ‘ä»¬äº†è§£å®‡å®™çš„æ¼”åŒ–å’Œå¼•åŠ›ç‰©ç†çš„åŸºæœ¬è§„å¾‹å…·æœ‰æå…¶é‡è¦çš„æ„ä¹‰ã€‚

{'conv_template': 'chatglm2', 'prompt': '[Round 1]\n\né—®ï¼šä½ å¥½\n\nç­”ï¼šä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚\n\n[Round 2]\n\né—®ï¼šè¯·ä½ è®²ä¸€ä¸ªå†·ç¬‘è¯\n\nç­”ï¼šä¸‹é¢æ˜¯ä¸€ä¸ªå†·ç¬‘è¯ï¼š\n\næœ‰ä¸€å¤©ï¼Œè€å¸ˆåœ¨è¯¾å ‚ä¸Šé—®ï¼šâ€œå¦‚æœæœ‰äº”åªé¸Ÿç«™åœ¨æ ‘æä¸Šï¼Œä½ ç”¨æ°”æªæ‰“æ­»äº†ä¸€åªï¼Œè¿˜å‰©ä¸‹å‡ åªï¼Ÿâ€\n\nå­¦ç”Ÿå›ç­”ï¼šâ€œè¿˜å‰©ä¸‹é›¶åªï¼Œå› ä¸ºå…¶ä»–é¸Ÿä¼šè¢«æªå£°å“é£ã€‚â€\n\nè€å¸ˆæ²‰æ€äº†ä¸€ä¼šå„¿ï¼Œç„¶åæ‘‡äº†æ‘‡å¤´ï¼šâ€œè¿™æ ·å•Šï¼Œé‚£åªèƒ½å†ç­‰ç­‰äº†ï¼Œç­‰ç¬¬äº”åªé¸Ÿè‡ªå·±é£ä¸‹æ¥çš„æ—¶å€™å†æ‰“ã€‚â€\n\nå­¦ç”Ÿå›åº”ï¼šâ€œå¤ªå¥½äº†ï¼Œæˆ‘æ­£å¥½æœ‰è¶³å¤Ÿçš„æ—¶é—´å¯ä»¥å†™ä¸€ç¯‡æ–‡ç« ã€‚â€\n\n[Round 3]\n\né—®ï¼šè¯·ä½ è§£é‡Šä¸€ä¸‹é»‘æ´\n\nç­”ï¼š', 'outputs': 'é»‘æ´æ˜¯å®‡å®™ä¸­ä¸€ç§æå…¶å·¨å¤§è´¨é‡å¯†é›†çš„å¤©ä½“ï¼Œå®ƒçš„å­˜åœ¨åŸºäºçˆ±å› æ–¯å¦çš„å¹¿ä¹‰ç›¸å¯¹è®ºã€‚é»‘æ´æ˜¯ç”±ä¸€ä¸ªäº‹ä»¶è§†ç•Œæ‰€åŒ…å›´çš„åŒºåŸŸï¼Œäº‹ä»¶è§†ç•Œæ˜¯ä¸€ç§ç±»ä¼¼äºæ•°å­¦â€œæ— å›å¤´ç‚¹â€çš„èŒƒå›´ï¼Œä¸€æ—¦ä»»ä½•ä¸œè¥¿è¿›å…¥äº†äº‹ä»¶è§†ç•Œï¼Œå°±å†ä¹Ÿæ— æ³•é€ƒè„±é»‘æ´çš„å¼•åŠ›ã€‚\n\né»‘æ´çš„å½¢æˆé€šå¸¸æ˜¯ç”±äºä¸€ä¸ªè¶…å¤§è´¨é‡æ’æ˜Ÿåœ¨æ­»äº¡æ—¶ï¼Œå…¶æ ¸å¿ƒå› ä¸ºå†…éƒ¨çš„å¼•åŠ›è€Œå¡Œç¼©æˆäº†ä¸€ä¸ªéå¸¸å°çš„åŒºåŸŸï¼Œå½¢æˆäº†ä¸€ä¸ªéå¸¸è‡´å¯†çš„ç‰©ä½“ã€‚è¿™ä¸ªç‰©ä½“çš„å¼•åŠ›éå¸¸å¼ºå¤§ï¼Œç”šè‡³è¿å…‰ä¹Ÿæ— æ³•é€ƒè„±ï¼Œå› æ­¤åœ¨å®‡å®™ä¸­çœ‹èµ·æ¥å°±åƒæ˜¯ä¸€ä¸ªâ€œé»‘æ´â€ã€‚\n\né»‘æ´çš„å¤§å°ç”±å…¶è´¨é‡å†³å®šï¼Œè´¨é‡è¶Šå¤§ï¼Œé»‘æ´çš„å¼•åŠ›å°±è¶Šå¼ºï¼Œäº‹ä»¶è§†ç•Œä¹Ÿå°±è¶Šå¤§ã€‚é»‘æ´çš„è´¨é‡å¯ä»¥é€šè¿‡æµ‹é‡å…¶è‡ªè½¬å’Œè†¨èƒ€æ¥ä¼°è®¡ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è§‚å¯Ÿå‘¨å›´å¤©ä½“çš„è¿åŠ¨æ¥ç¡®å®šã€‚\n\né»‘æ´æ˜¯å®‡å®™ä¸­æœ€ç¥ç§˜ã€æœ€å…·æœ‰æŒ‘æˆ˜æ€§çš„å¤©ä½“ä¹‹ä¸€ï¼Œå¯¹äºæˆ‘ä»¬äº†è§£å®‡å®™çš„æ¼”åŒ–å’Œå¼•åŠ›ç‰©ç†çš„åŸºæœ¬è§„å¾‹å…·æœ‰æå…¶é‡è¦çš„æ„ä¹‰ã€‚', 'speed (token/s)': 38.79}
```

---

> **å¤š GPU çš„ä½¿ç”¨æ–¹æ³•**

æ‚¨å¯ä»¥ä½¿ç”¨æ¨¡å‹å¹¶è¡Œæ€§æ¥èšåˆæ¥è‡ªåŒä¸€å°è®¡ç®—æœºä¸Šå¤šä¸ª GPU çš„ GPU å†…å­˜ã€‚

```shell
$ CUDA_VISIBLE_DEVICES=0,1 python3 -m fastchat.serve.cli --model-path ./model/chatglm2-6b --num-gpus 2 --debug
```

è¾“å‡ºçš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
é—®: ä½ å¥½
ç­”: ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚

{'conv_template': 'chatglm2', 'prompt': '[Round 1]\n\né—®ï¼šä½ å¥½\n\nç­”ï¼š', 'outputs': 'ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚', 'speed (token/s)': 12.65}

é—®: è¯·ä½ è¯¦ç»†è§£é‡Šä¸€ä¸‹é»‘æ´
ç­”: é»‘æ´æ˜¯å®‡å®™ä¸­ä¸€ç§æå…¶å·¨å¤§è´¨é‡å¯†åº¦çš„å¤©ä½“ï¼Œå®ƒå½¢æˆäºæ’æ˜Ÿæ¼”åŒ–è¿‡ç¨‹ä¸­çš„éå¸¸è§„é˜¶æ®µâ€”â€”è¶…æ–°æ˜Ÿçˆ†å‘æˆ–æ˜Ÿäº‘çš„ç¢°æ’ã€‚é»‘æ´çš„è¾¹ç•Œç§°ä¸ºäº‹ä»¶è§†ç•Œï¼Œè¶Šé è¿‘äº‹ä»¶è§†ç•Œï¼Œé»‘æ´çš„å¼•åŠ›å°±è¶Šå¼ºï¼Œè·ç¦»äº‹ä»¶è§†ç•Œè¶Šè¿œï¼Œé»‘æ´çš„å¼•åŠ›å°±è¶Šå¼±ã€‚

é»‘æ´å…·æœ‰éå¸¸å¼ºå¤§çš„å¼•åŠ›ï¼Œå³ä½¿æ˜¯å…‰ä¹Ÿæ— æ³•é€ƒè„±é»‘æ´çš„å¼•åŠ›èŒƒå›´ï¼Œå› æ­¤è¢«ç§°ä¸ºâ€œé»‘æ´â€ã€‚

é»‘æ´çš„å¤§å°ç”±å…¶è´¨é‡å†³å®šï¼Œè´¨é‡è¶Šå¤§ï¼Œé»‘æ´çš„è¾¹ç•Œäº‹ä»¶è§†ç•Œä¹Ÿå°±è¶Šå¤§ã€‚åœ¨å¤©æ–‡å­¦å®¶ä¸­ï¼Œé»‘æ´çš„è´¨é‡é€šå¸¸ç”¨å¤ªé˜³è´¨é‡æ¥è¡¡é‡ï¼Œæœ€å¤§çš„å·²çŸ¥é»‘æ´çš„è´¨é‡å¯ä»¥è¾¾åˆ°æ•°ç™¾äº¿ä¸ªå¤ªé˜³è´¨é‡ã€‚

é»‘æ´å¯¹å‘¨å›´ç‰©ä½“çš„å½±å“ä¹Ÿå¾ˆå¤§ï¼Œå¯ä»¥æ‘§æ¯å‘¨å›´çš„æ’æ˜Ÿå’Œæ˜Ÿäº‘ï¼Œç”šè‡³æ•´ä¸ªæ˜Ÿç³»ã€‚åœ¨é»‘æ´é™„è¿‘ï¼Œç‰©è´¨ä¼šè¢«å¸å…¥é»‘æ´ï¼Œå½¢æˆæ‰€è°“çš„â€œåå™¬ç›˜â€ã€‚åå™¬ç›˜ä¸­çš„ç‰©è´¨åœ¨é»‘æ´å¼ºå¤§çš„å¼•åŠ›ä½œç”¨ä¸‹ï¼Œä¼šè¿…é€ŸåŠ çƒ­ï¼Œäº§ç”Ÿå¼ºçƒˆçš„è¾å°„å’Œé«˜èƒ½ç²’å­ã€‚

é»‘æ´æ˜¯å®‡å®™ä¸­æœ€ç¥ç§˜ã€æœ€å…·æœ‰æŒ‘æˆ˜æ€§çš„å¤©ä½“ä¹‹ä¸€ï¼Œå¯¹äºæˆ‘ä»¬äº†è§£å®‡å®™çš„æ¼”åŒ–å’Œå¼•åŠ›ç‰©ç†çš„åŸºæœ¬è§„å¾‹å…·æœ‰æå…¶é‡è¦çš„æ„ä¹‰ã€‚

{'conv_template': 'chatglm2', 'prompt': '[Round 1]\n\né—®ï¼šä½ å¥½\n\nç­”ï¼šä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚\n\n[Round 2]\n\né—®ï¼šè¯·ä½ è¯¦ç»†è§£é‡Šä¸€ä¸‹é»‘æ´\n\nç­”ï¼š', 'outputs': 'é»‘æ´æ˜¯å®‡å®™ä¸­ä¸€ç§æå…¶å·¨å¤§è´¨é‡å¯†åº¦çš„å¤©ä½“ï¼Œå®ƒå½¢æˆäºæ’æ˜Ÿæ¼”åŒ–è¿‡ç¨‹ä¸­çš„éå¸¸è§„é˜¶æ®µâ€”â€”è¶…æ–°æ˜Ÿçˆ†å‘æˆ–æ˜Ÿäº‘çš„ç¢°æ’ã€‚é»‘æ´çš„è¾¹ç•Œç§°ä¸ºäº‹ä»¶è§†ç•Œï¼Œè¶Šé è¿‘äº‹ä»¶è§†ç•Œï¼Œé»‘æ´çš„å¼•åŠ›å°±è¶Šå¼ºï¼Œè·ç¦»äº‹ä»¶è§†ç•Œè¶Šè¿œï¼Œé»‘æ´çš„å¼•åŠ›å°±è¶Šå¼±ã€‚\n\né»‘æ´å…·æœ‰éå¸¸å¼ºå¤§çš„å¼•åŠ›ï¼Œå³ä½¿æ˜¯å…‰ä¹Ÿæ— æ³•é€ƒè„±é»‘æ´çš„å¼•åŠ›èŒƒå›´ï¼Œå› æ­¤è¢«ç§°ä¸ºâ€œé»‘æ´â€ã€‚\n\né»‘æ´çš„å¤§å°ç”±å…¶è´¨é‡å†³å®šï¼Œè´¨é‡è¶Šå¤§ï¼Œé»‘æ´çš„è¾¹ç•Œäº‹ä»¶è§†ç•Œä¹Ÿå°±è¶Šå¤§ã€‚åœ¨å¤©æ–‡å­¦å®¶ä¸­ï¼Œé»‘æ´çš„è´¨é‡é€šå¸¸ç”¨å¤ªé˜³è´¨é‡æ¥è¡¡é‡ï¼Œæœ€å¤§çš„å·²çŸ¥é»‘æ´çš„è´¨é‡å¯ä»¥è¾¾åˆ°æ•°ç™¾äº¿ä¸ªå¤ªé˜³è´¨é‡ã€‚\n\né»‘æ´å¯¹å‘¨å›´ç‰©ä½“çš„å½±å“ä¹Ÿå¾ˆå¤§ï¼Œå¯ä»¥æ‘§æ¯å‘¨å›´çš„æ’æ˜Ÿå’Œæ˜Ÿäº‘ï¼Œç”šè‡³æ•´ä¸ªæ˜Ÿç³»ã€‚åœ¨é»‘æ´é™„è¿‘ï¼Œç‰©è´¨ä¼šè¢«å¸å…¥é»‘æ´ï¼Œå½¢æˆæ‰€è°“çš„â€œåå™¬ç›˜â€ã€‚åå™¬ç›˜ä¸­çš„ç‰©è´¨åœ¨é»‘æ´å¼ºå¤§çš„å¼•åŠ›ä½œç”¨ä¸‹ï¼Œä¼šè¿…é€ŸåŠ çƒ­ï¼Œäº§ç”Ÿå¼ºçƒˆçš„è¾å°„å’Œé«˜èƒ½ç²’å­ã€‚\n\né»‘æ´æ˜¯å®‡å®™ä¸­æœ€ç¥ç§˜ã€æœ€å…·æœ‰æŒ‘æˆ˜æ€§çš„å¤©ä½“ä¹‹ä¸€ï¼Œå¯¹äºæˆ‘ä»¬äº†è§£å®‡å®™çš„æ¼”åŒ–å’Œå¼•åŠ›ç‰©ç†çš„åŸºæœ¬è§„å¾‹å…·æœ‰æå…¶é‡è¦çš„æ„ä¹‰ã€‚', 'speed (token/s)': 38.8}
```


æœ‰æ—¶ï¼Œhuggingface / transformers ä¸­çš„ â€œè‡ªåŠ¨â€ è®¾å¤‡æ˜ å°„ç­–ç•¥å¹¶ä¸èƒ½å®Œç¾åœ°å¹³è¡¡å¤šä¸ª GPU ä¹‹é—´çš„å†…å­˜åˆ†é…ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç”±äºä¸€å¼ å¡å°±è¶³ä»¥å°† ChatGLM-6B åŠ è½½åˆ°æ˜¾å¡ä¸­ï¼Œå› æ­¤å®é™…ä¸Šç¬¬äºŒå¼ å¡å¹¶ä¸ä¼šå ç”¨æ˜¾å­˜ï¼ˆå‡ ä¹ä¸èµ·ä½œç”¨ï¼‰ã€‚

å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨ `--max-gpu-memory` æŒ‡å®šæ¯ä¸ª GPU ç”¨äºå­˜å‚¨æ¨¡å‹æƒé‡çš„æœ€å¤§å†…å­˜ã€‚è¿™å…è®¸å®ƒä¸ºæ¿€æ´»åˆ†é…æ›´å¤šå†…å­˜ï¼Œå› æ­¤æ‚¨å¯ä»¥ä½¿ç”¨æ›´é•¿çš„ä¸Šä¸‹æ–‡é•¿åº¦æˆ–æ›´å¤§çš„æ‰¹å¤§å°ã€‚ä¾‹å¦‚ï¼š

```shell
$ CUDA_VISIBLE_DEVICES=0,1 python3 -m fastchat.serve.cli --model-path ./model/chatglm2-6b --num-gpus 2 --max-gpu-memory 8GiB --debug
```

---

> **çº¯ CPU çš„ä½¿ç”¨æ–¹æ³•**

```shell
$ python3 -m fastchat.serve.cli --model-path ./model/chatglm2-6b --device cpu --debug
```

è¾“å‡ºçš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
é—®: ä½ å¥½
ç­”: ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚

{'conv_template': 'chatglm2', 'prompt': '[Round 1]\n\né—®ï¼šä½ å¥½\n\nç­”ï¼š', 'outputs': 'ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚', 'speed (token/s)': 3.06}

é—®: è¯·ä½ ä»‹ç»ä¸€ä¸‹é»‘æ´
ç­”: å½“ç‰©è´¨çš„å¼•åŠ›è¶³å¤Ÿå¼ºå¤§æ—¶ï¼Œå®ƒä¼šå½¢æˆä¸€ä¸ªéå¸¸ç´§å‡‘çš„ç‰©ä½“ï¼Œå³é»‘æ´ã€‚é»‘æ´çš„è¾¹ç•Œç§°ä¸ºäº‹ä»¶è§†ç•Œï¼Œè¶Šé è¿‘äº‹ä»¶è§†ç•Œï¼Œé»‘æ´çš„å¼•åŠ›å°±è¶Šå¼ºã€‚åœ¨äº‹ä»¶è§†ç•Œå†…ï¼Œå¼•åŠ›ä½¿ä»»ä½•ç‰©è´¨éƒ½æ— æ³•é€ƒè„±ï¼Œæ‰€ä»¥é»‘æ´ä¹Ÿè¢«ç§°ä¸ºâ€œé»‘æ´â€ã€‚

é»‘æ´æ˜¯ç”±ä¸€ä¸ªå«åšçˆ±å› æ–¯å¦çš„ç‰©ç†å­¦å®¶åœ¨20ä¸–çºªæ—©æœŸæå‡ºçš„æ¦‚å¿µã€‚ä»–é€šè¿‡å¼•åŠ›ç†è®ºï¼Œå‘ç°äº†ä¸€ä¸ªè´¨é‡ä¸å…‰çº¿ä¼ æ’­é€Ÿåº¦æˆæ­£æ¯”çš„æƒ³æ³•ã€‚è¿™å°±æ˜¯è‘—åçš„å¼•åŠ›æ³¢æ¦‚å¿µã€‚

ç°å®ä¸­å·²ç»å‘ç°äº†å¾ˆå¤šé»‘æ´ï¼Œä½†ç§‘å­¦å®¶è¿˜æ— æ³•å‡†ç¡®åœ°è®¡ç®—å®ƒä»¬çš„è´¨é‡ã€‚é»‘æ´æ˜¯æˆ‘ä»¬ç›®å‰å®‡å®™ä¸­äº†è§£æœ€å°‘çš„ä¸€ç§ç‰©ä½“ï¼Œå› æ­¤æœ‰å…³é»‘æ´çš„ç ”ç©¶ä»ç„¶éå¸¸æ´»è·ƒã€‚

{'conv_template': 'chatglm2', 'prompt': '[Round 1]\n\né—®ï¼šä½ å¥½\n\nç­”ï¼šä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚\n\n[Round 2]\n\né—®ï¼šè¯·ä½ ä»‹ç»ä¸€ä¸‹é»‘æ´\n\nç­”ï¼š', 'outputs': 'å½“ç‰©è´¨çš„å¼•åŠ›è¶³å¤Ÿå¼ºå¤§æ—¶ï¼Œå®ƒä¼šå½¢æˆä¸€ä¸ªéå¸¸ç´§å‡‘çš„ç‰©ä½“ï¼Œå³é»‘æ´ã€‚é»‘æ´çš„è¾¹ç•Œç§°ä¸ºäº‹ä»¶è§†ç•Œï¼Œè¶Šé è¿‘äº‹ä»¶è§†ç•Œï¼Œé»‘æ´çš„å¼•åŠ›å°±è¶Šå¼ºã€‚åœ¨äº‹ä»¶è§†ç•Œå†…ï¼Œå¼•åŠ›ä½¿ä»»ä½•ç‰©è´¨éƒ½æ— æ³•é€ƒè„±ï¼Œæ‰€ä»¥é»‘æ´ä¹Ÿè¢«ç§°ä¸ºâ€œé»‘æ´â€ã€‚\n\né»‘æ´æ˜¯ç”±ä¸€ä¸ªå«åšçˆ±å› æ–¯å¦çš„ç‰©ç†å­¦å®¶åœ¨20ä¸–çºªæ—©æœŸæå‡ºçš„æ¦‚å¿µã€‚ä»–é€šè¿‡å¼•åŠ›ç†è®ºï¼Œå‘ç°äº†ä¸€ä¸ªè´¨é‡ä¸å…‰çº¿ä¼ æ’­é€Ÿåº¦æˆæ­£æ¯”çš„æƒ³æ³•ã€‚è¿™å°±æ˜¯è‘—åçš„å¼•åŠ›æ³¢æ¦‚å¿µã€‚\n\nç°å®ä¸­å·²ç»å‘ç°äº†å¾ˆå¤šé»‘æ´ï¼Œä½†ç§‘å­¦å®¶è¿˜æ— æ³•å‡†ç¡®åœ°è®¡ç®—å®ƒä»¬çš„è´¨é‡ã€‚é»‘æ´æ˜¯æˆ‘ä»¬ç›®å‰å®‡å®™ä¸­äº†è§£æœ€å°‘çš„ä¸€ç§ç‰©ä½“ï¼Œå› æ­¤æœ‰å…³é»‘æ´çš„ç ”ç©¶ä»ç„¶éå¸¸æ´»è·ƒã€‚', 'speed (token/s)': 3.49}
```

è¿˜å¯ä»¥ä½¿ç”¨ Intel AI Accelerator AVX512_BF16/AMX åŠ é€Ÿ CPU æ¨ç†ï¼Œä¾‹å¦‚ï¼š

```shell
$ CPU_ISA=amx python3 -m fastchat.serve.cli --model-path ./model/chatglm2-6b --device cpu --debug
```

è¾“å‡ºçš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
é—®: ä½ å¥½
ç­”: ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚

{'conv_template': 'chatglm2', 'prompt': '[Round 1]\n\né—®ï¼šä½ å¥½\n\nç­”ï¼š', 'outputs': 'ä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚', 'speed (token/s)': 3.4}

é—®: è¯·ä½ ä»‹ç»ä¸€ä¸‹é»‘æ´
ç­”: é»‘æ´æ˜¯å®‡å®™ä¸­ä¸€ç§æå…¶å¤©ä½“ï¼Œå®ƒçš„è¯ç”Ÿæºäºå¤©ä½“é—´çš„æ ¸èšå˜ã€‚å½“ä¸€ä¸ªéå¸¸å¤§è´¨é‡çš„å¤©ä½“è€—å°½å…¶æ ¸å¿ƒç‡ƒæ–™æ—¶ï¼Œä¼šåœ¨å†…éƒ¨å´©å¡Œå¹¶å¡Œç¼©æˆä¸ºä¸€ä¸ªæç«¯å¯†é›†ã€å¼ºå¼•åŠ›çš„ç‰©ä½“ã€‚è¿™ç§ç‰©ä½“ä¼šå¸æ”¶å‘¨å›´çš„ç‰©è´¨ï¼ŒåŒ…æ‹¬å…‰çº¿ï¼Œä½¿å®ƒä»¬æ— æ³•é€ƒé€¸ã€‚è¿™å°±æ˜¯é»‘æ´ã€‚

é»‘æ´çš„ä½“ç§¯é€šå¸¸å¾ˆå°ï¼Œç›´å¾„ä¸€èˆ¬åªæœ‰å‡ åå…¬é‡Œåˆ°æ•°ç™¾ä¸‡å…¬é‡Œä¸ç­‰ï¼Œä½†å®ƒä»¬çš„è´¨é‡å´éå¸¸å¤§ã€‚å¤©æ–‡å­¦å®¶è®¤ä¸ºï¼Œä¸€ä¸ªé»‘æ´çš„è´¨é‡å¯èƒ½è¾¾åˆ°å¤ªé˜³è´¨é‡çš„æ•°åäº¿å€ã€‚

é»‘æ´çš„å¼ºå¼•åŠ›åœºéå¸¸å¼ºå¤§ï¼Œç”šè‡³è¿å…‰éƒ½æ— æ³•é€ƒè„±ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå®ƒä»¬è¢«ç§°ä¸ºâ€œé»‘æ´â€ï¼Œå› ä¸ºå®ƒä»¬ä¼šè®©ä»»ä½•æ¥è¿‘å®ƒä»¬çš„ç‰©ä½“è¢«å¸å¼•è¿›å»ï¼ŒåŒ…æ‹¬å…‰çº¿ã€‚åœ¨é»‘æ´çš„è¡¨é¢ï¼Œç‰©è´¨è¢«æ’•è£‚æˆæœ€åŸºæœ¬çš„ç²’å­ï¼Œä¾‹å¦‚åŸå­æ ¸å’Œå¤¸å…‹ã€‚

é»‘æ´å¯¹å®‡å®™çš„æ¼”åŒ–å’Œç»“æ„äº§ç”Ÿäº†å¾ˆå¤§çš„å½±å“ã€‚ä¾‹å¦‚ï¼Œå®ƒä»¬å¯ä»¥æ”¹å˜æ˜Ÿç³»å’Œæ˜Ÿå›¢çš„å½¢æˆå’Œæ¼”åŒ–ï¼Œè¿˜å¯ä»¥å½±å“å®‡å®™å¤§å°ºåº¦ç»“æ„ã€‚åŒæ—¶ï¼Œé»‘æ´ä¹Ÿæ˜¯å¤©æ–‡å­¦å®¶ç ”ç©¶å®‡å®™ä¸­å¼•åŠ›å’Œç‰©è´¨æ€§è´¨çš„é‡è¦é¢†åŸŸã€‚

{'conv_template': 'chatglm2', 'prompt': '[Round 1]\n\né—®ï¼šä½ å¥½\n\nç­”ï¼šä½ å¥½ğŸ‘‹ï¼æˆ‘æ˜¯äººå·¥æ™ºèƒ½åŠ©æ‰‹ ChatGLM2-6Bï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚\n\n[Round 2]\n\né—®ï¼šè¯·ä½ ä»‹ç»ä¸€ä¸‹é»‘æ´\n\nç­”ï¼š', 'outputs': 'é»‘æ´æ˜¯å®‡å®™ä¸­ä¸€ç§æå…¶å¤©ä½“ï¼Œå®ƒçš„è¯ç”Ÿæºäºå¤©ä½“é—´çš„æ ¸èšå˜ã€‚å½“ä¸€ä¸ªéå¸¸å¤§è´¨é‡çš„å¤©ä½“è€—å°½å…¶æ ¸å¿ƒç‡ƒæ–™æ—¶ï¼Œä¼šåœ¨å†…éƒ¨å´©å¡Œå¹¶å¡Œç¼©æˆä¸ºä¸€ä¸ªæç«¯å¯†é›†ã€å¼ºå¼•åŠ›çš„ç‰©ä½“ã€‚è¿™ç§ç‰©ä½“ä¼šå¸æ”¶å‘¨å›´çš„ç‰©è´¨ï¼ŒåŒ…æ‹¬å…‰çº¿ï¼Œä½¿å®ƒä»¬æ— æ³•é€ƒé€¸ã€‚è¿™å°±æ˜¯é»‘æ´ã€‚\n\né»‘æ´çš„ä½“ç§¯é€šå¸¸å¾ˆå°ï¼Œç›´å¾„ä¸€èˆ¬åªæœ‰å‡ åå…¬é‡Œåˆ°æ•°ç™¾ä¸‡å…¬é‡Œä¸ç­‰ï¼Œä½†å®ƒä»¬çš„è´¨é‡å´éå¸¸å¤§ã€‚å¤©æ–‡å­¦å®¶è®¤ä¸ºï¼Œä¸€ä¸ªé»‘æ´çš„è´¨é‡å¯èƒ½è¾¾åˆ°å¤ªé˜³è´¨é‡çš„æ•°åäº¿å€ã€‚\n\né»‘æ´çš„å¼ºå¼•åŠ›åœºéå¸¸å¼ºå¤§ï¼Œç”šè‡³è¿å…‰éƒ½æ— æ³•é€ƒè„±ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå®ƒä»¬è¢«ç§°ä¸ºâ€œé»‘æ´â€ï¼Œå› ä¸ºå®ƒä»¬ä¼šè®©ä»»ä½•æ¥è¿‘å®ƒä»¬çš„ç‰©ä½“è¢«å¸å¼•è¿›å»ï¼ŒåŒ…æ‹¬å…‰çº¿ã€‚åœ¨é»‘æ´çš„è¡¨é¢ï¼Œç‰©è´¨è¢«æ’•è£‚æˆæœ€åŸºæœ¬çš„ç²’å­ï¼Œä¾‹å¦‚åŸå­æ ¸å’Œå¤¸å…‹ã€‚\n\né»‘æ´å¯¹å®‡å®™çš„æ¼”åŒ–å’Œç»“æ„äº§ç”Ÿäº†å¾ˆå¤§çš„å½±å“ã€‚ä¾‹å¦‚ï¼Œå®ƒä»¬å¯ä»¥æ”¹å˜æ˜Ÿç³»å’Œæ˜Ÿå›¢çš„å½¢æˆå’Œæ¼”åŒ–ï¼Œè¿˜å¯ä»¥å½±å“å®‡å®™å¤§å°ºåº¦ç»“æ„ã€‚åŒæ—¶ï¼Œé»‘æ´ä¹Ÿæ˜¯å¤©æ–‡å­¦å®¶ç ”ç©¶å®‡å®™ä¸­å¼•åŠ›å’Œç‰©è´¨æ€§è´¨çš„é‡è¦é¢†åŸŸã€‚', 'speed (token/s)': 3.73}
```

---

> **é‡åŒ–**

å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ  `--load-8bit` ä¸Šè¿°å‘½ä»¤æ¥å¯ç”¨ 8 ä½å‹ç¼©ã€‚è¿™æ ·å¯ä»¥å°†å†…å­˜ä½¿ç”¨é‡å‡å°‘å¤§çº¦ä¸€åŠï¼Œè€Œæ¨¡å‹è´¨é‡ä¼šç•¥æœ‰ä¸‹é™ã€‚å®ƒä¸ CPUã€GPU å’Œ Metal åç«¯å…¼å®¹ã€‚

```shell
$ python3 -m fastchat.serve.cli --model-path lmsys/vicuna-7b-v1.5 --load-8bit
```

é™¤æ­¤ä¹‹å¤–ï¼Œæ‚¨è¿˜å¯ä»¥æ·»åŠ åˆ° `--cpu-offloading` ä¸Šè¿°å‘½ä»¤ä¸­ï¼Œå°†ä¸é€‚åˆ GPU çš„æƒé‡å¸è½½åˆ° CPU å†…å­˜ä¸Šã€‚è¿™éœ€è¦å¯ç”¨ 8 ä½å‹ç¼©å¹¶å®‰è£… `bitsandbytes` åŒ…ï¼Œè¯¥åŒ…ä»…åœ¨ Linux æ“ä½œç³»ç»Ÿä¸Šå¯ç”¨ã€‚

### Web UI

è¦ä½¿ç”¨ Web UI æä¾›æœåŠ¡ï¼Œæ‚¨éœ€è¦ä¸‰ä¸ªä¸»è¦ç»„ä»¶ï¼šä¸ç”¨æˆ·äº¤äº’çš„ Web æœåŠ¡å™¨ã€æ‰˜ç®¡ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å‹çš„æ¨¡å‹å·¥ä½œå™¨ï¼Œä»¥åŠç”¨äºåè°ƒ Web æœåŠ¡å™¨å’Œæ¨¡å‹ä½œä¸šï¼ˆworkerï¼‰çš„æ§åˆ¶å™¨ã€‚

---

é¦–å…ˆï¼Œå¼€å¯æ§åˆ¶å™¨ï¼š

```shell
$ python3 -m fastchat.serve.controller
```

è¿™ä¸ªæ§åˆ¶å™¨ç”¨äºç®¡ç†åˆ†å¸ƒå¼çš„ä½œä¸šï¼ˆworkerï¼‰çº¿ç¨‹ã€‚

---

æ¥ç€ï¼Œå¯åŠ¨æ¨¡å‹ä½œä¸šï¼ˆmodel workerï¼‰ï¼š

```shell
$ python3 -m fastchat.serve.model_worker --model-path lmsys/vicuna-7b-v1.5
```

ç­‰åˆ°è¯¥è¿‡ç¨‹å®ŒæˆåŠ è½½æ¨¡å‹ï¼Œæ‚¨ä¼šçœ‹åˆ° â€œUvicorn running on ...â€ã€‚æ¨¡å‹ä½œä¸šå°†è‡ªèº« **æ³¨å†Œ** åˆ°æ§åˆ¶å™¨ã€‚

è¦ç¡®ä¿æ¨¡å‹ä½œä¸šå·²ç»æ­£ç¡®è¿æ¥åˆ°æ§åˆ¶å™¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å‘é€æµ‹è¯•æ¶ˆæ¯ `test_message`ï¼š

```shell
$ python3 -m fastchat.serve.test_message --model-name vicuna-7b-v1.5
```

---

æœ€åï¼Œå¼€å¯ Gradio ç½‘ç»œæœåŠ¡ï¼š

```shell
$ python3 -m fastchat.serve.gradio_web_server
```

è¿™æ˜¯ç”¨æˆ·å°†ä¸ä¹‹äº¤äº’çš„ç”¨æˆ·ç•Œé¢ã€‚é€šè¿‡æ‰§è¡Œè¿™äº›æ­¥éª¤ï¼Œæ‚¨å°†èƒ½å¤Ÿä½¿ç”¨ Web UI æä¾›æ¨¡å‹ã€‚æ‚¨ç°åœ¨å¯ä»¥æ‰“å¼€æµè§ˆå™¨å¹¶ä¸æ¨¡ç‰¹èŠå¤©ã€‚å¦‚æœæ¨¡å‹æœªæ˜¾ç¤ºï¼Œè¯·å°è¯•é‡æ–°å¯åŠ¨ gradio çš„ Web æœåŠ¡å™¨ã€‚

### æ”¯æŒçš„æ¨¡å‹

### API

> å‚è€ƒï¼š
>
> - FastChat [æ–‡æ¡£](https://github.com/lm-sys/FastChat/blob/main/docs/openai_api.md)

FastChat ä¸ºå…¶æ”¯æŒçš„æ¨¡å‹æä¾›ä¸ OpenAI å…¼å®¹çš„ APIï¼Œå› æ­¤æ‚¨å¯ä»¥å°† FastChat ç”¨ä½œ OpenAI API çš„æœ¬åœ°æ›¿ä»£å“ã€‚FastChat æœåŠ¡å™¨å…¼å®¹ [openai-python](https://github.com/openai/openai-python) åº“å’Œ cURL å‘½ä»¤ã€‚

æ”¯æŒä»¥ä¸‹ OpenAI APIï¼š

- Chat Completionsï¼ˆå‚è€ƒï¼šhttps://platform.openai.com/docs/api-reference/chatï¼‰

- Completionsï¼ˆå‚è€ƒï¼šhttps://platform.openai.com/docs/api-reference/completionsï¼‰

- Embeddingsï¼ˆå‚è€ƒï¼šhttps://platform.openai.com/docs/api-reference/embeddingsï¼‰

---

éƒ¨ç½²è¿‡ç¨‹å¦‚ä¸‹ï¼š

![](https://rudeigerc.dev/posts/llm-inference-with-fastchat/images/fastchat.png)

> å›¾ç‰‡æ¥æºï¼š[ä½¿ç”¨ FastChat å¿«é€Ÿéƒ¨ç½² LLM æœåŠ¡](https://rudeigerc.dev/posts/llm-inference-with-fastchat/)

é¦–å…ˆï¼Œå¯åŠ¨æ§åˆ¶å™¨ï¼š

```shell
$ python -m fastchat.serve.controller --host 127.0.0.1 --port 21001 

2024-01-21 22:01:25 | INFO | controller | args: Namespace(host='127.0.0.1', port=21001, dispatch_method='shortest_queue', ssl=False)
2024-01-21 22:01:25 | ERROR | stderr | INFO:     Started server process [40157]
2024-01-21 22:01:25 | ERROR | stderr | INFO:     Waiting for application startup.
2024-01-21 22:01:25 | ERROR | stderr | INFO:     Application startup complete.
2024-01-21 22:01:25 | ERROR | stderr | INFO:     Uvicorn running on http://127.0.0.1:21001 (Press CTRL+C to quit)

2024-01-21 22:01:55 | INFO | controller | Register a new worker: http://localhost:21002
2024-01-21 22:01:55 | INFO | controller | Register done: http://localhost:21002, {'model_names': ['chatglm2-6b'], 'speed': 1, 'queue_length': 0}
2024-01-21 22:01:55 | INFO | stdout | INFO:     127.0.0.1:47242 - "POST /register_worker HTTP/1.1" 200 OK
2024-01-21 22:02:46 | INFO | controller | Register an existing worker: http://localhost:21002
2024-01-21 22:02:46 | INFO | controller | Register done: http://localhost:21002, {'model_names': ['chatglm2-6b'], 'speed': 1, 'queue_length': 0}

# å‘é€å¿ƒè·³åŒ…
2024-01-21 22:02:46 | INFO | stdout | INFO:     127.0.0.1:40412 - "POST /register_worker HTTP/1.1" 200 OK
2024-01-21 22:03:31 | INFO | controller | Receive heart beat. http://localhost:21002
2024-01-21 22:03:31 | INFO | stdout | INFO:     127.0.0.1:59534 - "POST /receive_heart_beat HTTP/1.1" 200 OK
2024-01-21 22:04:16 | INFO | controller | Receive heart beat. http://localhost:21002
```

ç„¶åï¼Œå¯åŠ¨æ¨¡å‹å·¥ä½œèŠ‚ç‚¹ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°æ§åˆ¶å™¨ä¸­ï¼š

```shell
$ python -m fastchat.serve.model_worker --model-path ./model/chatglm2-6b --host 127.0.0.1 --port 8100

2024-01-21 22:02:28 | INFO | model_worker | args: Namespace(host='127.0.0.1', port=8100, worker_address='http://localhost:21002', controller_address='http://localhost:21001', model_path='./model/chatglm2-6b', revision='main', device='cuda', gpus=None, num_gpus=1, max_gpu_memory=None, dtype=None, load_8bit=False, cpu_offloading=False, gptq_ckpt=None, gptq_wbits=16, gptq_groupsize=-1, gptq_act_order=False, awq_ckpt=None, awq_wbits=16, awq_groupsize=-1, enable_exllama=False, exllama_max_seq_len=4096, exllama_gpu_split=None, exllama_cache_8bit=False, enable_xft=False, xft_max_seq_len=4096, xft_dtype=None, model_names=None, conv_template=None, embed_in_truncate=False, limit_worker_concurrency=5, stream_interval=2, no_register=False, seed=None, debug=False, ssl=False)

2024-01-21 22:02:28 | INFO | model_worker | Loading the model ['chatglm2-6b'] on worker d3b69e58 ... 
Loading checkpoint shards: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 7/7 [00:09<00:00,  1.40s/it]

2024-01-21 22:02:38 | ERROR | stderr |
2024-01-21 22:02:46 | INFO | model_worker | Register to controller
2024-01-21 22:02:46 | ERROR | stderr | INFO:     Started server process [41219]
2024-01-21 22:02:46 | ERROR | stderr | INFO:     Waiting for application startup.
2024-01-21 22:02:46 | ERROR | stderr | INFO:     Application startup complete.
2024-01-21 22:02:46 | ERROR | stderr | INFO:     Uvicorn running on http://127.0.0.1:8100 (Press CTRL+C to quit)

# å‘é€å¿ƒè·³åŒ…
2024-01-21 22:03:31 | INFO | model_worker | Send heart beat. Models: ['chatglm2-6b']. Semaphore: None. call_ct: 0. worker_id: d3b69e58.
2024-01-21 22:04:16 | INFO | model_worker | Send heart beat. Models: ['chatglm2-6b']. Semaphore: None. call_ct: 0. worker_id: d3b69e58.
2024-01-21 22:05:01 | INFO | model_worker | Send heart beat. Models: ['chatglm2-6b']. Semaphore: None. call_ct: 0. worker_id: d3b69e58.
2024-01-21 22:05:46 | INFO | model_worker | Send heart beat. Models: ['chatglm2-6b']. Semaphore: None. call_ct: 0. worker_id: d3b69e58.
2024-01-21 22:06:31 | INFO | model_worker | Send heart beat. Models: ['chatglm2-6b']. Semaphore: None. call_ct: 0. worker_id: d3b69e58.
```

æœ€åï¼Œå¯åŠ¨ RESTful API æœåŠ¡å™¨ï¼š

```shell
$ python -m fastchat.serve.openai_api_server --host 127.0.0.1 --port 8000

2024-01-21 22:04:11 | INFO | openai_api_server | args: Namespace(host='127.0.0.1', port=8000, controller_address='http://localhost:21001', allow_credentials=False, allowed_origins=['*'], allowed_methods=['*'], allowed_headers=['*'], api_keys=None, ssl=False)

2024-01-21 22:04:11 | ERROR | stderr | INFO:     Started server process [41435]
2024-01-21 22:04:11 | ERROR | stderr | INFO:     Waiting for application startup.
2024-01-21 22:04:11 | ERROR | stderr | INFO:     Application startup complete.
2024-01-21 22:04:11 | ERROR | stderr | INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

---

æ‰§è¡Œä¸‹åˆ—çš„å‘½ä»¤ï¼ŒæŸ¥çœ‹æ‰€æœ‰å·²ç»æ³¨å†Œåˆ°æ§åˆ¶å™¨çš„å·¥ä½œèŠ‚ç‚¹ï¼š

```shell
$ curl http://127.0.0.1:8000/v1/models
```

ä½†æ˜¯ï¼Œå‘ç°è¿”å›çš„ç»“æ„æ˜¯ç©ºçš„ï¼š

```json
{
  "object": "list",
  "data": []
}
```

å…·ä½“çš„åŸå› å°šä¸æ¸…æ¥šï¼ŒGithub ä»“åº“ä¸Šä¹Ÿæœ‰ä¸€äº› Issue åé¦ˆäº†è¿™ä¸€é—®é¢˜ï¼Œä½†æ˜¯å°šä¸çŸ¥é“å¦‚ä½•å¤„ç†ã€‚

TODO


## é«˜çº§åŠŸèƒ½

### å¯æ‰©å±•æ€§

å¯ä»¥å°† **å¤šä¸ªæ¨¡å‹ä½œä¸šæ³¨å†Œåˆ°å•ä¸ªæ§åˆ¶å™¨**ï¼Œè¯¥æ§åˆ¶å™¨å¯ç”¨äºä¸ºå…·æœ‰æ›´é«˜ååé‡çš„å•ä¸ªæ¨¡å‹æä¾›æœåŠ¡ï¼Œæˆ–åŒæ—¶ä¸ºå¤šä¸ªæ¨¡å‹æä¾›æœåŠ¡ã€‚æ‰§è¡Œæ­¤æ“ä½œæ—¶ï¼Œè¯·ä¸ºä¸åŒçš„æ¨¡å‹å·¥ä½œçº¿ç¨‹åˆ†é…ä¸åŒçš„ GPU å’Œç«¯å£ã€‚

```shell
# worker 0
$ CUDA_VISIBLE_DEVICES=0 python3 -m fastchat.serve.model_worker --model-path lmsys/vicuna-7b-v1.5 --controller http://localhost:21001 --port 31000 --worker http://localhost:31000

# worker 1
$ CUDA_VISIBLE_DEVICES=1 python3 -m fastchat.serve.model_worker --model-path lmsys/fastchat-t5-3b-v1.0 --controller http://localhost:21001 --port 31001 --worker http://localhost:31001
```

è¿˜å¯ä»¥å¯åŠ¨ä¸€ä¸ª **å¤šé€‰é¡¹å¡** çš„ gradio æœåŠ¡å™¨ï¼Œå…¶ä¸­åŒ…æ‹¬ Chatbot Arena é€‰é¡¹å¡ï¼š

```shell
$ python3 -m fastchat.serve.gradio_web_server_multi
```

### ä¸ vLLM é›†æˆ

> å‚è€ƒï¼š
>
> - [vLLM Integration](https://github.com/lm-sys/FastChat/blob/main/docs/vllm_integration.md)

![vLLM's Logo](https://raw.githubusercontent.com/vllm-project/vllm/main/docs/source/assets/logos/vllm-logo-text-light.png)

åŸºäº huggingface / transformers çš„é»˜è®¤æ¨¡å‹ worker å…·æœ‰å¾ˆå¥½çš„å…¼å®¹æ€§ï¼Œä½†é€Ÿåº¦å¯èƒ½å¾ˆæ…¢ã€‚

å¦‚æœæƒ³è¦é«˜ååé‡çš„æ‰¹é‡æœåŠ¡ï¼Œå¯ä»¥å°è¯•ä¸ **vLLM é›†æˆ**ã€‚

1. å®‰è£… vLLM

```shell
$ pip install vllm
```

2. å¯åŠ¨æ¨¡å‹å·¥ä½œç¨‹åºæ—¶ï¼Œå°†æ™®é€šå·¥ä½œç¨‹åº `fastchat.serve.model_worker` æ›¿æ¢ä¸º vLLM å·¥ä½œç¨‹åº `fastchat.serve.vllm_worker`ï¼š

```shell
$ python3 -m fastchat.serve.vllm_worker --model-path lmsys/vicuna-7b-v1.5
```

å…¶ä»–çš„æ‰€æœ‰å‘½ä»¤ï¼ˆå¦‚æ§åˆ¶å™¨ã€gradio Web æœåŠ¡å™¨å’Œ OpenAI API æœåŠ¡å™¨ï¼‰ä¿æŒä¸å˜ã€‚

å¦‚æœçœ‹åˆ°åˆ†è¯å™¨é”™è¯¯ï¼Œè¯·å°è¯•ï¼š

```shell
$ python3 -m fastchat.serve.vllm_worker --model-path lmsys/vicuna-7b-v1.5 --tokenizer hf-internal-testing/llama-tokenizer
```

å¦‚æœä½¿ç”¨ AWQ é‡åŒ–æ¨¡å‹ï¼Œè¯·å°è¯•ï¼š

```shell
$ python3 -m fastchat.serve.vllm_worker --model-path TheBloke/vicuna-7B-v1.5-AWQ --quantization awq
```



### ç¬¬ä¸‰æ–¹ Web UI




## Controller è§£æ

> å‚è€ƒï¼š
>
> - çŸ¥ä¹ï¼š[FastChat æ¡†æ¶æºç è§£æä¹‹ controller.pyï¼ˆå¤§æ¨¡å‹è°ƒåº¦åŸç†ï¼‰](https://zhuanlan.zhihu.com/p/656506047)

[controller.py](https://github.com/lm-sys/FastChat/blob/main/fastchat/serve/controller.py) ä¸­çš„ `get_worker_address()` æ–¹æ³•å®šä¹‰äº†ä¸¤ç§å·¥ä½œèŠ‚ç‚¹ï¼ˆworkerï¼‰çš„è°ƒåº¦æ–¹æ³•ï¼š**LOTTERY** å’Œ **SHORTEST_QUEUE**ã€‚è¿™ä¸¤ç§æ–¹æ³•å†³å®šäº†å½“æœ‰ä¸€ä¸ªä»»åŠ¡éœ€è¦æ‰§è¡Œæ—¶ï¼Œåº”è¯¥é€‰æ‹©å“ªä¸ªå·¥ä½œèŠ‚ç‚¹æ¥æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ã€‚

å¦‚æœæ²¡æœ‰æŒ‡å®šä¸Šè¿°ä¸¤ç§æ–¹æ³•ä¸­çš„ä»»ä½•ä¸€ç§ï¼Œæ–¹æ³•ä¼šå¼•å‘ä¸€ä¸ªå€¼é”™è¯¯ã€‚

æ€»çš„æ¥è¯´ï¼Œè¿™ä¸¤ç§è°ƒåº¦æ–¹æ³•éƒ½è¯•å›¾åœ¨å·¥ä½œèŠ‚ç‚¹ä¹‹é—´å‡è¡¡åœ°åˆ†é…ä»»åŠ¡ï¼Œä½†å®ƒä»¬çš„æ–¹æ³•å’Œä¾§é‡ç‚¹ä¸åŒï¼š

- LOTTERY æ–¹æ³•ä¾§é‡äºå·¥ä½œèŠ‚ç‚¹çš„é€Ÿåº¦

- SHORTEST_QUEUE æ–¹æ³•ä¾§é‡äºå·¥ä½œèŠ‚ç‚¹çš„å½“å‰è´Ÿè½½

### LOTTERYï¼ˆæŠ½å¥–ï¼‰

è¿™ç§æ–¹æ³•åŸºäºæ¯ä¸ª **å·¥ä½œèŠ‚ç‚¹çš„é€Ÿåº¦** æ¥éšæœºé€‰æ‹©ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ã€‚å·¥ä½œèŠ‚ç‚¹çš„é€Ÿåº¦è¶Šé«˜ï¼Œè¢«é€‰ä¸­çš„æ¦‚ç‡å°±è¶Šå¤§ã€‚

- é¦–å…ˆï¼Œè¯¥æ–¹æ³•æ”¶é›†æ‰€æœ‰æ”¯æŒç»™å®šæ¨¡å‹çš„å·¥ä½œèŠ‚ç‚¹çš„åç§°å’Œé€Ÿåº¦

- ç„¶åï¼Œå®ƒå°†é€Ÿåº¦è½¬æ¢ä¸ºä¸€ä¸ª **æ¦‚ç‡åˆ†å¸ƒ**ï¼Œè¿™æ ·é€Ÿåº¦è¾ƒé«˜çš„å·¥ä½œèŠ‚ç‚¹ä¼šæœ‰æ›´é«˜çš„æ¦‚ç‡è¢«é€‰ä¸­

- ä½¿ç”¨ `np.random.choice` æ ¹æ®è¿™ä¸ªæ¦‚ç‡åˆ†å¸ƒéšæœºé€‰æ‹©ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹

- æœ‰ä¸€ä¸ªè¢«æ³¨é‡Šæ‰çš„éƒ¨åˆ†ï¼Œå®ƒä¼šåœ¨è¿”å›å·¥ä½œèŠ‚ç‚¹ä¹‹å‰æ£€æŸ¥å·¥ä½œèŠ‚ç‚¹çš„çŠ¶æ€ã€‚**å¦‚æœå·¥ä½œèŠ‚ç‚¹ä¸å¯ç”¨ï¼Œå®ƒä¼šä»åˆ—è¡¨ä¸­ç§»é™¤ï¼Œå¹¶é‡æ–°è®¡ç®—æ¦‚ç‡åˆ†å¸ƒï¼Œç„¶åå†æ¬¡å°è¯•é€‰æ‹©**


### SHORTEST_QUEUEï¼ˆæœ€çŸ­é˜Ÿåˆ—ï¼‰

è¿™ç§æ–¹æ³•é€‰æ‹© **å½“å‰é˜Ÿåˆ—é•¿åº¦æœ€çŸ­** çš„å·¥ä½œèŠ‚ç‚¹ã€‚é˜Ÿåˆ—é•¿åº¦è¡¨ç¤ºå·¥ä½œèŠ‚ç‚¹ä¸Š **å¾…å¤„ç†çš„ä»»åŠ¡æ•°é‡**ã€‚è¿™ç§æ–¹æ³•çš„ç›®çš„æ˜¯å°½é‡å‡è¡¡åœ°åˆ†é…ä»»åŠ¡ï¼Œé¿å…æŸäº›å·¥ä½œèŠ‚ç‚¹è¿‡è½½è€Œå…¶ä»–å·¥ä½œèŠ‚ç‚¹ç©ºé—²ã€‚

- é¦–å…ˆï¼Œæ”¶é›†æ‰€æœ‰æ”¯æŒç»™å®šæ¨¡å‹çš„å·¥ä½œèŠ‚ç‚¹çš„åç§°å’Œé˜Ÿåˆ—é•¿åº¦

- ç„¶åï¼Œè®¡ç®—æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹çš„é˜Ÿåˆ—é•¿åº¦ä¸å…¶é€Ÿåº¦çš„ **æ¯”å€¼**ã€‚è¿™æ˜¯å› ä¸ºé€Ÿåº¦è¾ƒå¿«çš„å·¥ä½œèŠ‚ç‚¹å¯ä»¥æ›´å¿«åœ°å¤„ç†ä»»åŠ¡ï¼Œæ‰€ä»¥å³ä½¿å®ƒçš„é˜Ÿåˆ—ç¨å¾®é•¿ä¸€ç‚¹ï¼Œå®ƒä»ç„¶å¯èƒ½æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©

- ä½¿ç”¨ `np.argmin` æ‰¾åˆ°é˜Ÿåˆ—é•¿åº¦ä¸é€Ÿåº¦æ¯”å€¼æœ€å°çš„å·¥ä½œèŠ‚ç‚¹

- é€‰æ‹©çš„å·¥ä½œèŠ‚ç‚¹çš„é˜Ÿåˆ—é•¿åº¦åŠ  1ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªæ–°ä»»åŠ¡è¢«åˆ†é…ç»™å®ƒ




### controller æ•´ä½“ç»“æ„

`controller.py` æ˜¯ä¸€ä¸ªä½¿ç”¨ FastAPI æ¡†æ¶çš„æœåŠ¡å™¨åº”ç”¨ï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ **ç®¡ç†å’Œè°ƒåº¦å¤šä¸ªå·¥ä½œèŠ‚ç‚¹**ï¼ˆworkerï¼‰ã€‚è¿™äº›å·¥ä½œèŠ‚ç‚¹å¯ä»¥ç†è§£ä¸ºè¿è¡Œç‰¹å®šæ¨¡å‹çš„æœåŠ¡å™¨å®ä¾‹ã€‚

ä»¥ä¸‹æ˜¯å¯¹ä»£ç çš„è¯¦ç»†è§£æï¼š

1. å¯¼å…¥æ¨¡å—ï¼šä»£ç å¼€å§‹æ—¶å¯¼å…¥äº†ä¸€ç³»åˆ—å¿…è¦çš„æ¨¡å—ï¼Œå¦‚ `argparse` ç”¨äºå‘½ä»¤è¡Œå‚æ•°è§£æï¼Œ`asyncio` ç”¨äºå¼‚æ­¥æ“ä½œï¼Œ`dataclasses` ç”¨äºæ•°æ®ç±»ï¼Œ`fastapi` ç”¨äºAPIæœåŠ¡å™¨ç­‰ã€‚

2. æ—¥å¿—è®¾ç½®ï¼šä½¿ç”¨ `build_logger` å‡½æ•°ä» `fastchat.utils` åˆ›å»ºä¸€ä¸ªæ—¥å¿—è®°å½•å™¨ã€‚

3. è°ƒåº¦æ–¹æ³•æšä¸¾ï¼šå®šä¹‰äº†ä¸€ä¸ª `DispatchMethod` æšä¸¾ï¼Œå®ƒæœ‰ä¸¤ä¸ªå€¼ï¼š`LOTTERY` å’Œ `SHORTEST_QUEUE`ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸¤ç§ä¸åŒçš„å·¥ä½œèŠ‚ç‚¹é€‰æ‹©ç­–ç•¥ã€‚

4. å·¥ä½œèŠ‚ç‚¹ä¿¡æ¯æ•°æ®ç±»ï¼š`WorkerInfo` æ•°æ®ç±»ç”¨äºå­˜å‚¨å·¥ä½œèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå¦‚ **æ¨¡å‹åç§°ã€é€Ÿåº¦ã€é˜Ÿåˆ—é•¿åº¦** ç­‰ã€‚

5. å¿ƒè·³æ§åˆ¶å™¨ï¼š`heart_beat_controller` å‡½æ•°æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œç”¨äºå®šæœŸæ£€æŸ¥å·¥ä½œèŠ‚ç‚¹çš„å¿ƒè·³å¹¶åˆ é™¤è¿‡æœŸçš„å·¥ä½œèŠ‚ç‚¹ã€‚

6. Controllerç±»ï¼š

  - `__init__`ï¼šåˆå§‹åŒ–å‡½æ•°ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„å·¥ä½œèŠ‚ç‚¹ä¿¡æ¯å­—å…¸å’Œä¸€ä¸ªå¿ƒè·³çº¿ç¨‹
  
  - `register_worker`ï¼šæ³¨å†Œæˆ–æ›´æ–°å·¥ä½œèŠ‚ç‚¹çš„ä¿¡æ¯
  
  - `get_worker_status`ï¼šä»å·¥ä½œèŠ‚ç‚¹è·å–å…¶çŠ¶æ€
  
  - `remove_worker`ï¼šä»æ³¨å†Œåˆ—è¡¨ä¸­åˆ é™¤å·¥ä½œèŠ‚ç‚¹
  
  - `refresh_all_workers`ï¼šåˆ·æ–°æ‰€æœ‰å·¥ä½œèŠ‚ç‚¹çš„çŠ¶æ€
  
  - `list_models`ï¼šåˆ—å‡ºæ‰€æœ‰å¯ç”¨æ¨¡å‹
  
  - `get_worker_address`ï¼šæ ¹æ®é€‰æ‹©çš„è°ƒåº¦æ–¹æ³•è¿”å›ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹åœ°å€
  
  - `receive_heart_beat`ï¼šæ¥æ”¶å·¥ä½œèŠ‚ç‚¹çš„å¿ƒè·³å¹¶æ›´æ–°å…¶çŠ¶æ€
  
  - `remove_stale_workers_by_expiration`ï¼šåˆ é™¤è¿‡æœŸçš„å·¥ä½œèŠ‚ç‚¹
  
  - `handle_no_worker` å’Œ `handle_worker_timeout`ï¼šå¤„ç†æ²¡æœ‰å·¥ä½œèŠ‚ç‚¹æˆ–å·¥ä½œèŠ‚ç‚¹è¶…æ—¶çš„æƒ…å†µ
  
  - `worker_api_get_status`å’Œ `worker_api_generate_stream`ï¼šå…è®¸æ§åˆ¶å™¨ä½œä¸ºå·¥ä½œèŠ‚ç‚¹æ¥è·å–çŠ¶æ€æˆ–ç”Ÿæˆæ•°æ®æµ


7. FastAPI åº”ç”¨ï¼šå®šä¹‰äº†ä¸€ä¸ª FastAPI åº”ç”¨å’Œä¸€ç³»åˆ— API ç«¯ç‚¹ï¼Œå¦‚ `register_worker`ã€`refresh_all_workers`ã€`list_models` ç­‰ã€‚

8. `create_controller` å‡½æ•°ï¼šè§£æå‘½ä»¤è¡Œå‚æ•°å¹¶åˆ›å»ºä¸€ä¸ªæ§åˆ¶å™¨å®ä¾‹

9. ä¸»æ‰§è¡Œéƒ¨åˆ†ï¼šå¦‚æœè¿™ä¸ªè„šæœ¬æ˜¯ä¸»ç¨‹åºï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ§åˆ¶å™¨å¹¶è¿è¡Œ FastAPI åº”ç”¨




### è°ƒåº¦ä»£ç è§£æ

```python
def get_worker_address(self, model_name: str):
    # åŸºäºæŠ½å¥–çš„è°ƒåº¦æ–¹æ³•
    if self.dispatch_method == DispatchMethod.LOTTERY:
        worker_names = [] # ç”¨äºå­˜å‚¨æ”¯æŒç»™å®šæ¨¡å‹çš„å·¥ä½œèŠ‚ç‚¹çš„åç§°
        worker_speeds = [] # ç”¨äºå­˜å‚¨æ”¯æŒç»™å®šæ¨¡å‹çš„å·¥ä½œèŠ‚ç‚¹çš„å¤„ç†é€Ÿåº¦
        # éå†æ‰€æœ‰å·²æ³¨å†Œçš„å·¥ä½œèŠ‚ç‚¹
        for w_name, w_info in self.worker_info.items():
            # å¦‚æœå½“å‰å·¥ä½œèŠ‚ç‚¹æ”¯æŒç»™å®šçš„æ¨¡å‹
            if model_name in w_info.model_names:
                worker_names.append(w_name)
                worker_speeds.append(w_info.speed)
        # å°†å·¥ä½œèŠ‚ç‚¹çš„é€Ÿåº¦è½¬æ¢ä¸º NumPy æ•°ç»„
        worker_speeds = np.array(worker_speeds, dtype=np.float32)
        norm = np.sum(worker_speeds) # è®¡ç®—æ‰€æœ‰å·¥ä½œèŠ‚ç‚¹çš„é€Ÿåº¦æ€»å’Œ
        if norm < 1e-4: # å¦‚æœæ€»é€Ÿåº¦æ¥è¿‘äºé›¶ï¼Œåˆ™æ²¡æœ‰åˆé€‚çš„å·¥ä½œèŠ‚ç‚¹
            return ""
        worker_speeds = worker_speeds / norm # è®¡ç®—æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹é€Ÿåº¦å¯¹åº”çš„æ¦‚ç‡åˆ†å¸ƒ
        if True:  # è¿™æ˜¯ä¸€ä¸ªå§‹ç»ˆä¸ºçœŸçš„æ¡ä»¶ï¼Œå¯èƒ½æ˜¯ä»£ç çš„é—ç•™éƒ¨åˆ†ï¼ˆå¯å¿½ç•¥ï¼‰
            pt = np.random.choice(np.arange(len(worker_names)), p=worker_speeds)
            worker_name = worker_names[pt]
            return worker_name
        # åœ¨é€‰æ‹©å·¥ä½œèŠ‚ç‚¹ä¹‹å‰ï¼Œå…ˆæ£€æŸ¥è¢«é€‰ä¸­çš„å·¥ä½œèŠ‚ç‚¹çš„çŠ¶æ€
        # å¦‚æœå·¥ä½œèŠ‚ç‚¹ä¸å¯ç”¨ï¼Œå®ƒä¼šä»åˆ—è¡¨ä¸­ç§»é™¤ï¼Œå¹¶é‡æ–°è®¡ç®—æ¦‚ç‡åˆ†å¸ƒï¼Œç„¶åå†æ¬¡å°è¯•é€‰æ‹©
        while True:
            pt = np.random.choice(np.arange(len(worker_names)), p=worker_speeds)
            worker_name = worker_names[pt]
            if self.get_worker_status(worker_name):
                break
            else:
                self.remove_worker(worker_name)
                worker_speeds[pt] = 0
                norm = np.sum(worker_speeds)
                if norm < 1e-4:
                    return ""
                worker_speeds = worker_speeds / norm
                continue
        return worker_name

    # åŸºäºæœ€çŸ­é˜Ÿåˆ—çš„è°ƒåº¦æ–¹æ³•
    elif self.dispatch_method == DispatchMethod.SHORTEST_QUEUE:
        worker_names = [] # ç”¨äºå­˜å‚¨æ”¯æŒç»™å®šæ¨¡å‹çš„å·¥ä½œèŠ‚ç‚¹çš„åç§°
        worker_qlen = [] # ç”¨äºå­˜å‚¨å·¥ä½œèŠ‚ç‚¹çš„é˜Ÿåˆ—é•¿åº¦ä¸å¤„ç†é€Ÿåº¦çš„æ¯”å€¼
        # éå†æ‰€æœ‰å·²æ³¨å†Œçš„å·¥ä½œèŠ‚ç‚¹
        for w_name, w_info in self.worker_info.items():
            # å¦‚æœå½“å‰å·¥ä½œèŠ‚ç‚¹æ”¯æŒç»™å®šçš„æ¨¡å‹
            if model_name in w_info.model_names:
                worker_names.append(w_name)
                # è®¡ç®—é˜Ÿåˆ—é•¿åº¦ä¸é€Ÿåº¦çš„æ¯”å€¼
                worker_qlen.append(w_info.queue_length / w_info.speed)
        if len(worker_names) == 0: # å¦‚æœæ²¡æœ‰å·¥ä½œèŠ‚ç‚¹æ”¯æŒç»™å®šçš„æ¨¡å‹ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
            return ""
        # æ‰¾åˆ°é˜Ÿåˆ—é•¿åº¦ä¸å¤„ç†é€Ÿåº¦æ¯”å€¼æœ€å°çš„å·¥ä½œèŠ‚ç‚¹
        min_index = np.argmin(worker_qlen)
        w_name = worker_names[min_index]
        # å¢åŠ è¯¥å·¥ä½œèŠ‚ç‚¹çš„é˜Ÿåˆ—é•¿åº¦ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªæ–°ä»»åŠ¡è¢«åˆ†é…ç»™å®ƒ
        self.worker_info[w_name].queue_length += 1
        # è®°å½•ä¸€æ¡æ—¥å¿—ï¼Œæ˜¾ç¤ºæ‰€æœ‰å·¥ä½œèŠ‚ç‚¹çš„åç§°ã€é˜Ÿåˆ—é•¿åº¦å’Œè¢«é€‰ä¸­çš„å·¥ä½œèŠ‚ç‚¹çš„åç§°
        logger.info(
            f"names: {worker_names}, queue_lens: {worker_qlen}, ret: {w_name}"
        )
        return w_name
    
    else: # å¦‚æœæ²¡æœ‰æŒ‡å®šä¸Šè¿°ä¸¤ç§æ–¹æ³•ä¸­çš„ä»»ä½•ä¸€ç§ï¼Œå¼•å‘ä¸€ä¸ªå€¼é”™è¯¯
        raise ValueError(f"Invalid dispatch method: {self.dispatch_method}")
```


## å‚è€ƒ

- Githubï¼š

  - [FastChat](https://github.com/lm-sys/FastChat)

  - [vLLM](https://github.com/vllm-project/vllm)


- æ–‡æ¡£ï¼š
  
  - [vLLM's supported models](https://docs.vllm.ai/en/latest/models/supported_models.html)
  
  - [vLLM Integration](https://github.com/lm-sys/FastChat/blob/main/docs/vllm_integration.md)

- CSDNï¼š

  - [Fastchatï¼šåŸºäº fastapi æ„å»ºå¤§æ¨¡å‹åŠ è½½æœåŠ¡](https://blog.csdn.net/qq128252/article/details/132759107)

  - [è¶…å…¨é¢æ•´ç† fastAPI (ä»å…¥é—¨åˆ°è¿ç”¨)ï¼Œè¿›æ¥çœ‹åç§’é’Ÿå†èµ°ä¸è¿Ÿ](https://blog.csdn.net/my_name_is_learn/article/details/109819127)

- çŸ¥ä¹ï¼š

  - [FastChat æ¡†æ¶æºç è§£æä¹‹ controller.pyï¼ˆå¤§æ¨¡å‹è°ƒåº¦åŸç†ï¼‰](https://zhuanlan.zhihu.com/p/656506047)